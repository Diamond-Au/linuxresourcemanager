<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SOURCEINFO</title>
    <link rel="stylesheet" href="./index.css" />
    <script src="./echarts.js"></script>
  </head>
  <body>
    <div class="container">
      <!-- the display of cpu -->
      <div class="cpu-wrapper"></div>

      <!-- the display of memory -->
      <div class="memory-wrapper">
        <div class="memory-info">
          <h1>memory info</h1>
          <div id="memory" style="width: 300px; height: 300px"></div>
          <div class="memory-detail" id="memory-detail"></div>
        </div>
        <div class="swap-info">
          <h1>swap info</h1>
          <div id="swap" style="width: 300px; height: 300px"></div>
          <div class="swap-detail" id="swap-detail"></div>
        </div>
      </div>

      <!-- the display of net -->
      <div class="net-wrapper">
        <div class="receive-info">
          <div
            class="receive"
            id="receive"
            style="width: 300px; height: 300px"
          ></div>
          <div class="receive-detail" id="receive-detail"></div>
        </div>
        <div class="send-info">
          <div class="send" id="send" style="width: 300px; height: 300px"></div>
          <div class="send-detail" id="send-detail"></div>
        </div>
      </div>
    </div>
  </body>
  <script>
    const {
      getComputerNetInfo,
      getComputerSwapInfo,
      getComputerMemotyInfo,
      kbToGB,
      byteToMB,
    } = require("../../utils/index.js");
    const { Emitter } = require("../../utils/events.js");
    const {
      getMemoryOrSawpOption,
      getReceiveOrSendOption,
    } = require("../../config/config.js");
    var swapDetail = document.getElementById("swap-detail");
    var memoryDetail = document.getElementById("memory-detail");
    var receiveDetail = document.getElementById("receive-detail");
    var sendDetail = document.getElementById("send-detail");

    /*
     * caculate the net speed
     */
    function getNetSpeed(time) {
      let {
        receiveBytes,
        receivePacks,
        sendBytes,
        sendPacks,
      } = getComputerNetInfo();

      setInterval(() => {
        let res = getComputerNetInfo();

        Emitter.emit("10s", {
          resSpeed: parseInt((res.receiveBytes - receiveBytes) / time),
          receiveBytes: res.receiveBytes,
          sendSpeed: parseInt((res.sendBytes - sendBytes) / time),
          sendBytes: res.sendBytes,
        });
        receiveBytes = res.receiveBytes;
        receivePacks = res.receivePacks;
        sendBytes = res.sendBytes;
        sendPacks = res.sendPacks;
      }, time * 1000);
    }

    function getNetTemplate(data) {
      let template = `
        <span>正在${data.type}:${
        "  " + parseInt(data.speed / 1024)
      }KB/s</span></br>
        <span>一共${data.type}:${
        "  " + byteToMB(parseInt(data.sum), 1)
      }MiB</span>
      `;
      return template;
    }

    window.onload = function () {
      var swapMyChart = echarts.init(document.getElementById("swap"));
      var memoryMyChart = echarts.init(document.getElementById("memory"));
      var receiveMyChart = echarts.init(document.getElementById("receive"));
      var sendMyChart = echarts.init(document.getElementById("send"));

      var swapInfo = getComputerSwapInfo();
      var memoryInfo = getComputerMemotyInfo();
      let used = parseInt(swapInfo.used);
      let all = parseInt(swapInfo.size);
      let left = all - used;
      let swapOption = getMemoryOrSawpOption({ used, left });
      let rate = ((used / all) * 100).toFixed(1) + "%";
      let swapTemplate = `
        <span>${(used / 1024).toFixed(2)}MiB (${rate})</span>
        <span>共${kbToGB(all, 2)}GiB</span>
      `;
      swapDetail.innerHTML = swapTemplate;

      all = parseInt(memoryInfo[0]["MemTotal"]);
      left = parseInt(memoryInfo[0]["MemAvailable"]);
      used = all - left;
      let memoryOption = getMemoryOrSawpOption({ used, left });
      rate = ((used / all) * 100).toFixed(1) + "%";
      let Cached = memoryInfo[0]["Cached"];
      let memoryTemplate = `
        <span>${kbToGB(used, 2)}GiB(${rate}) 共${kbToGB(all, 1)}GiB</span></br>
        <span>cache: ${kbToGB(parseInt(Cached), 1)}GiB</span>
      `;

      // deal with the net echarts

      let reveiceOption = getReceiveOrSendOption();
      let sendOption = getReceiveOrSendOption();

      console.log(reveiceOption === sendDetail);

      receiveMyChart.setOption(reveiceOption, true);
      sendMyChart.setOption(sendOption, true);
      getNetSpeed(1);
      Emitter.on("10s", (data) => {
        console.log(data);
        let receiveTem = getNetTemplate({
          type: "receive",
          speed: data.resSpeed,
          sum: data.receiveBytes,
        });
        let sendTmp = getNetTemplate({
          type: "send",
          speed: data.sendSpeed,
          sum: data.sendBytes,
        });

        receiveDetail.innerHTML = receiveTem;
        sendDetail.innerHTML = sendTmp;

        reveiceOption.series[0].data[0].value = byteToMB(data.resSpeed, 1);
        sendOption.series[0].data[0].value = byteToMB(data.sendSpeed, 1);
        receiveMyChart.setOption(reveiceOption);
        sendMyChart.setOption(sendOption);
      });

      // set the echarts
      memoryDetail.innerHTML = memoryTemplate;
      swapMyChart.setOption(swapOption);
      memoryMyChart.setOption(memoryOption);
    };
  </script>
</html>
